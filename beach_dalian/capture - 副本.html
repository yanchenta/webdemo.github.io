<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0,  minimum-scale=1.0, maximum-scale=1.0" />
	<title></title>
	<link rel="stylesheet" type="text/css" href="css/capture_i5.css"/>
	<script type="text/javascript">
		var agent = navigator.userAgent.toLowerCase();
		var isIos = false;
		if(agent.indexOf("iphone") >= 0 || agent.indexOf("ipod") >= 0 || agent.indexOf("iPad") >=0){
			isIos = true;
		}
		else{
			isIos = false;
			//window.location.href = "capture2.html";
		}
	</script>
</head>
<body>
	<div class="banner">
		<img class="img-hidden" alt="" src=""/>

		<img class="tmpimg" alt="" src="" style="display:block;position:absolute;left:-10000px;top:-10000px;"/>

		<img class="img-randbg" alt="" src=""/>
		<!--<canvas class="canvas-hidden" width="147" height="382"></canvas>-->
		<input class="file-load-img" type="file" accept="image/*"/>
		<canvas class="canvas-target" width="320" height="391"></canvas>
	</div>
	<div class="main-body">
		<div class="div-main-top">
			<img class="img-hidden2" alt="" src=""/>
			<img class="img-newframe" style="display:block;position:absolute;left:98px;top:113px;width:122px;height:163px;" alt="" src="images/i5/img-frame1.png"/>
			<!--<canvas class="canvas-target" width="640" height="626"></canvas>-->
			
			<canvas id="canvas-transform" style="display:none;" width="320" height="391"></canvas>
			
			<div class="div-notice-area" draggable="false">
				<div class="div-text-notice">
					<div class="div-hide-noticearea"></div>
				</div>
				<!--上传按钮-->
				<div class="div-btn-uploadimg"></div>
				<!--旋转按钮-->
				<div class="btn-turnleft"></div>
				<div class="btn-turnright"></div>
			</div>
		</div>
		<div class="div-main-bottom">
			<input class="hidden-text" type="hidden" value="新浪微博#青春逗比邂逅金石滩#@大连金石滩景区"/>
			<div class="div-changeimg"></div>
			<div class="div-shareweibo"></div>
			<div class="div-shareweixin"></div>
		</div>
		
	</div>
	<div class="footer"></div>
</body>
<script type="text/javascript" src="js/common.js"></script>
<script type="text/javascript" src="js/upload_ext2.js"></script>
<script type="text/javascript" src="js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="js/shake.js"></script>
<script type="text/javascript">
	
	//隐藏notice区域
	document.getElementsByClassName("div-hide-noticearea")[0].onclick = function(){
		document.getElementsByClassName("div-text-notice")[0].style.display = "none";
	}
	
	var rate1280 = 1/8;
	var rate3264 = 1/20;
	var rate960 = 1/6;
	//var rateOther = 163/document.getElementsByClassName("img-hidden")[0].width;
	var delayload = false;
	//选择图片完成后
	document.getElementsByClassName("file-load-img")[0].onchange = function(){
		var img_hidden = document.getElementsByClassName("img-hidden")[0];
		img_hidden.style.width = "auto";
		img_hidden.style.height = "auto";
		
		var file = this.files[0];
		if(!file) return;
		
		document.getElementsByClassName("div-text-notice")[0].style.display = "none";//hide button
		document.getElementsByClassName("div-btn-uploadimg")[0].style.display = "none";
		
		var URL = window.URL && window.URL.createObjectURL ? window.URL :
            window.webkitURL && window.webkitURL.createObjectURL ? window.webkitURL : null;
		if (!URL) { throw Error("No createObjectURL function found to create blob url"); }
		
		
		img_hidden.onload = function(){
			var img_hidden2 = document.getElementsByClassName("img-hidden2")[0];
			var img_newframe = document.getElementsByClassName("img-newframe")[0];
			delayload = false;
			//alert("img_hidden.width:" + img_hidden.width + ", img_hidden.height:" + img_hidden.height);
			if(img_hidden.width == 960 && img_hidden.height == 1280){
				if(!img_hidden2.style) img_hidden2.style = {};
				
				img_hidden2.style.position = "absolute";
				img_hidden2.style.left = (320 - img_hidden.width * rate1280) / 2 + "px";
				img_hidden2.style.top = (391 - img_hidden.height * rate1280) / 2 + "px";
				img_hidden2.style.width = (img_hidden.width * rate1280) + "px";
				img_hidden2.style.height = (img_hidden.height * rate1280) + "px";
				img_hidden2.style.zIndex = "1010";
				
				img_newframe.style.display = "block";
				img_newframe.style.position = "absolute";
				img_newframe.style.left = ((320 - img_hidden.width * rate1280) / 2 - 15) + "px";
				img_newframe.style.top = ((391 - img_hidden.height * rate1280) / 2 - 13) + "px";
				img_newframe.style.width = ((img_hidden.width * rate1280) + 30) + "px";
				img_newframe.style.height = ((img_hidden.height * rate1280) + 26) + "px";
				img_newframe.style.zIndex = "1011";
				
				//alert(1 + ".img_newframe.width:" + img_newframe.width + ", img_newframe.height:" + img_newframe.height + ", img_newframe.src" + img_newframe.src);
			}
			else if(img_hidden.width == 1280 && img_hidden.height == 960){
				if(!img_hidden2.style) img_hidden2.style = {};
				
				img_hidden2.style.position = "absolute";
				img_hidden2.style.left = (320 - img_hidden.width * rate1280) / 2 + "px";
				img_hidden2.style.top = (391 - img_hidden.height * rate1280) / 2 + "px";
				img_hidden2.style.width = (img_hidden.width * rate1280) + "px";
				img_hidden2.style.height = (img_hidden.height * rate1280) + "px";
				img_hidden2.style.zIndex = "1010";
				
				img_newframe.style.display = "block";
				img_newframe.style.position = "absolute";
				img_newframe.style.left = ((320 - img_hidden.width * rate1280) / 2 - 15) + "px";
				img_newframe.style.top = ((391 - img_hidden.height * rate1280) / 2 - 13) + "px";
				img_newframe.style.width = ((img_hidden.width * rate1280) + 30) + "px";
				img_newframe.style.height = ((img_hidden.height * rate1280) + 26) + "px";
				img_newframe.style.zIndex = "1011";
				
				//alert(2 + ".img_newframe.width:" + img_newframe.width + ", img_newframe.height:" + img_newframe.height + ", img_newframe.src" + img_newframe.src);
			}
			else if(img_hidden.width == 3264 && img_hidden.height == 2448){
				if(!img_hidden2.style) img_hidden2.style = {};
				
				img_hidden2.style.position = "absolute";
				img_hidden2.style.left = (320 - img_hidden.width * rate3264) / 2 + "px";
				img_hidden2.style.top = (391 - img_hidden.height * rate3264) / 2+ "px";
				img_hidden2.style.width = (img_hidden.width * rate3264) + "px";
				img_hidden2.style.height = (img_hidden.height * rate3264) + "px";
				img_hidden2.style.zIndex = "1010";
				
				img_newframe.style.display = "block";
				img_newframe.style.position = "absolute";
				img_newframe.style.left = ((320 - img_hidden.width * rate3264) / 2 - 15) + "px";
				img_newframe.style.top = ((391 - img_hidden.height * rate3264) / 2 - 13)+ "px";
				img_newframe.style.width = ((img_hidden.width * rate3264) + 30) + "px";
				img_newframe.style.height = ((img_hidden.height * rate3264) + 26) + "px";
				img_newframe.style.zIndex = "1011";
				//alert(3 + ".img_newframe.width:" + img_newframe.width + ", img_newframe.height:" + img_newframe.height + ", img_newframe.src" + img_newframe.src);
			}
			else if(img_hidden.width == 2448 && img_hidden.height == 3264){
				if(!img_hidden2.style) img_hidden2.style = {};
				
				img_hidden2.style.position = "absolute";
				img_hidden2.style.left = (320 - img_hidden.width * rate3264) / 2 + "px";
				img_hidden2.style.top = (391 - img_hidden.height * rate3264) / 2 + "px";
				img_hidden2.style.width = (img_hidden.width * rate3264) + "px";
				img_hidden2.style.height = (img_hidden.height * rate3264) + "px";
				img_hidden2.style.zIndex = "1010";
				
				img_newframe.style.display = "block";
				img_newframe.style.position = "absolute";
				img_newframe.style.left = ((320 - img_hidden.width * rate3264) / 2 - 15) + "px";
				img_newframe.style.top = ((391 - img_hidden.height * rate3264) / 2 - 13) + "px";
				img_newframe.style.width = ((img_hidden.width * rate3264) + 30) + "px";
				img_newframe.style.height = ((img_hidden.height * rate3264) + 26) + "px";
				img_newframe.style.zIndex = "1011";
				//alert(4 + ".img_newframe.width:" + img_newframe.width + ", img_newframe.height:" + img_newframe.height + ", img_newframe.src" + img_newframe.src);
			}
			else if((img_hidden.width == 960 || img_hidden.width == 1136) && img_hidden.height == 640){
				if(!img_hidden2.style) img_hidden2.style = {};
				
				img_hidden2.style.position = "absolute";
				img_hidden2.style.left = (320 - img_hidden.width * rate960) / 2 + "px";
				img_hidden2.style.top = (391 - img_hidden.height * rate960) / 2 + "px";
				img_hidden2.style.width = (img_hidden.width * rate960) + "px";
				img_hidden2.style.height = (img_hidden.height * rate960) + "px";
				img_hidden2.style.zIndex = "1010";
				
				img_newframe.style.display = "block";
				img_newframe.style.position = "absolute";
				img_newframe.style.left = ((320 - img_hidden.width * rate960) / 2 - 15) + "px";
				img_newframe.style.top = ((391 - img_hidden.height * rate960) / 2 - 13) + "px";
				img_newframe.style.width = ((img_hidden.width * rate960) + 30) + "px";
				img_newframe.style.height = ((img_hidden.height * rate960) + 26) + "px";
				img_newframe.style.zIndex = "1011";
				//alert(4 + ".img_newframe.width:" + img_newframe.width + ", img_newframe.height:" + img_newframe.height + ", img_newframe.src" + img_newframe.src);
			}
			else if(img_hidden.width == 640 && (img_hidden.height == 960 || img_hidden.height == 1136)){
				if(!img_hidden2.style) img_hidden2.style = {};
				
				img_hidden2.style.position = "absolute";
				img_hidden2.style.left = (320 - img_hidden.width * rate960) / 2 + "px";
				img_hidden2.style.top = (391 - img_hidden.height * rate960) / 2 + "px";
				img_hidden2.style.width = (img_hidden.width * rate960) + "px";
				img_hidden2.style.height = (img_hidden.height * rate960) + "px";
				img_hidden2.style.zIndex = "1010";
				
				img_newframe.style.display = "block";
				img_newframe.style.position = "absolute";
				img_newframe.style.left = ((320 - img_hidden.width * rate960) / 2 - 15) + "px";
				img_newframe.style.top = ((391 - img_hidden.height * rate960) / 2 - 13) + "px";
				img_newframe.style.width = ((img_hidden.width * rate960) + 30) + "px";
				img_newframe.style.height = ((img_hidden.height * rate960) + 26) + "px";
				img_newframe.style.zIndex = "1011";
				//alert(4 + ".img_newframe.width:" + img_newframe.width + ", img_newframe.height:" + img_newframe.height + ", img_newframe.src" + img_newframe.src);
			}
			else{
				img_hidden2.style.position = "absolute";
				//img_hidden2.style.left = (320 - img_hidden.width * rateOther) / 2 + "px";
				//img_hidden2.style.left = (320 - img_hidden.width * rateOther) / 2 + "px";
				img_hidden2.style.left = 78 + "px";
				//img_hidden2.style.top = (391 - img_hidden.height * rate960) / 2 + "px";
				img_hidden2.style.top = 113 + "px";
				img_hidden2.style.width = 163 + "px";
				//img_hidden2.style.height = (img_hidden.height * rate960) + "px";
				img_hidden2.style.height = "auto";
				
				img_hidden2.style.zIndex = "1010";
				
				img_hidden2.style.display = "none";
				delayload = true;
				
				img_hidden2.style.display = "block";
				//alert(rateOther + "," + img_hidden2.offsetWidth + "," + img_hidden2.offsetHeight);
				
			}
			
			img_hidden2.onload = function(){
				//加载后的回调
				var _canvasTrans = document.getElementById("canvas-transform");
				var _imgData = this;
				var _maskDiv = document.getElementsByClassName("div-top-transform")[0];
				//var _turnLeftBtn = document.getElementsByClassName("btn-turnleft")[0];
				//var _turnRightBtn = document.getElementsByClassName("btn-turnright")[0];
				var _saveTransformBtn = null;
				//initload = function(canvasTrans, imgData, maskDiv, turnLeftBtn, turnRightBtn, saveTransformBtn, endFunc)
				
				/*ext_upload_pieces.prototype.initload(_canvasTrans, _imgData, _maskDiv, _turnLeftBtn, _turnRightBtn, _saveTransformBtn, function(){
					//updatePhoto();
				});*/
				//_turnLeftBtn.style.display = "block";
				//_turnRightBtn.style.display = "block";
				//updatePhoto();
				if(delayload){
					img_newframe.style.display = "block";
					img_newframe.style.position = "absolute";
					img_newframe.style.left = ((320 - img_hidden2.width) / 2 - 15) + "px";
					img_newframe.style.top = (img_hidden2.offsetTop - 11) + "px";
					img_newframe.style.width = (img_hidden2.width + 30) + "px";
					img_newframe.style.height = (img_hidden2.height + 22) + "px";
					img_newframe.style.zIndex = "1011";
				}
				
			};
			img_hidden2.src = img_hidden.src;
		};
		img_hidden.src = URL.createObjectURL(file);//加载图片src到img对象;
	};
	
	//
	document.getElementsByClassName("div-btn-uploadimg")[0].onclick = function(){
		document.getElementsByClassName("file-load-img")[0].click();
	};
	
	//
	document.getElementsByClassName("div-changeimg")[0].onclick = function(){
		document.getElementsByClassName("div-btn-uploadimg")[0].click();
	};
	
	//分享微博 事件绑定
	document.getElementsByClassName("div-shareweibo")[0].onclick = function(){
		//合成最后的图片
		isSubmit = true;
		
		updatePhoto();//更新背景图，且上传图片
		
		/*setTimeout(function(){
			isSubmit = false;
			updatePhoto();//更新背景图，但是不上传图片
		}, 10000);*/
	};
	
	//分享微信 事件绑定
	document.getElementsByClassName("div-shareweixin")[0].onclick = function(){
		document.getElementsByClassName("div-text-notice")[0].style.display = "block";
	};
	
	function drawImageByPieces(canvasTarget, imageData){
		//imageData.width;
		//imageData.height;
		var offTop = imageData.offsetTop;
		var offLeft = imageData.offsetLeft;
		
		var ctx = canvasTarget.getContext("2d");
		for(var i = 1; i <= imageData.width; i++){
			var colData = ctx.getImageData(0, 0, i, imageData.height).data;
			for(j = 1; j <= imageData.height; j++){
				var alpha = colData[(j - 1) * 4 + 3];
				if(0 !== alpha){
					ctx.drawImage(imageData, offLeft + i, offTop + j, 1, 1, i, j, 1, 1);
				}
			}
		}
	}
	
	function detectVerticalSquash(img) {
		var iw = img.naturalWidth, ih = img.naturalHeight;
		var canvas = document.createElement('canvas');
		canvas.width = 1;
		canvas.height = ih;
		var ctx = canvas.getContext('2d');
		ctx.drawImage(img, 0, 0);
		var data = ctx.getImageData(0, 0, 1, ih).data;
		// search image edge pixel position in case it is squashed vertically.
		var sy = 0;
		var ey = ih;
		var py = ih;
		while (py > sy) {
			var alpha = data[(py - 1) * 4 + 3];
			if (alpha === 0) {
				ey = py;
			} else {
				sy = py;
			}
			py = (ey + sy) >> 1;
		}
		var ratio = (py / ih);
		return (ratio===0)?1:ratio;
	}
	
	var changePhotpBgIdx = 0;
	var isSubmit = false;
	var isInsubmit = false;
	function updatePhoto(){
		
		document.getElementsByClassName("img-randbg")[0].onload = function(){
			
			var _canvas = document.getElementsByClassName("canvas-target")[0];
			var _ctx = _canvas.getContext("2d");
			_ctx.clearRect(0, 0, _canvas.width, _canvas.height);
			
			//画背景图
			_ctx.drawImage(this, 0, 5, 320, 391);
			_ctx.save();
			
			//document.getElementsByClassName("div-top-transform")[0].style.display = "none";
			if(isSubmit && !isInsubmit){
				isInsubmit = true;
				
				//画照片
				var img1 = document.getElementsByClassName("img-hidden2")[0];
				var left1 = img1.offsetLeft;
				var top1 = img1.offsetTop;
				var width1 = img1.width;
				var height1 = img1.height;
				//
				var tmpimg = document.getElementsByClassName("img-hidden")[0];
				
				var sRatio = 1;
				try{
					detectVerticalSquash(img1);
				}
				catch(ex){
					alert(ex.message);
				}
				//alert(left1 * sRatio + "," + top1 * sRatio);
				var ratio2 = (tmpimg.width / width1) > (tmpimg.width / height1) ? (tmpimg.width / width1) : (tmpimg.width / height1);
				sRatio = sRatio * ratio2;
				
				if(tmpimg.width == 1280 && tmpimg.height == 960){
					_ctx.drawImage(tmpimg, left1, top1, width1, height1);
					alert("draw1:" + left1 + "," + top1 + "," + width1 + "," + height1);
				}
				else{
					_ctx.drawImage(img1, 0, 0, img1.width * sRatio, img1.height * sRatio, left1, top1, width1, height1);
					alert("draw2:" + img1.width * sRatio + "," + img1.height * sRatio + "," + left1 + "," + top1 + "," + width1 + ", " + height1);
				}
				
				/*
				alert("tmpimg"+tmpimg.width+" "+tmpimg.height);
			//	tmpimg.width=width1;
			//	tmpimg.height=height1;
			//	alert("tmpimg"+tmpimg.width+" "+tmpimg.height);
				 alert("(" + left1 + "," + top1 + ";" + width1 + "," + height1 + ")");
				//_ctx.drawImage(tmpimg, left1, top1, width1, height1);
				_ctx.drawImage(tmpimg, left1, top1, tmpimg.width/16, tmpimg.height/4);
				//drawImageByPieces(_canvas, img1);
				*/
				
				//画相框
				var img2 = document.getElementsByClassName("img-newframe")[0];
				var left2 = img2.offsetLeft;
				var top2 = img2.offsetTop;
				var width2 = img2.width;
				var height2 = img2.height;
				if(tmpimg.width == 3362 && tmpimg.height == 2248){
					height2 = img2.height * 3/4;
				}
				//alert("(" + left2 + "," + top2 + ";" + width2 + "," + height2 + ")");
				_ctx.drawImage(img2, left2, top2, width2, height2);
				//drawImageByPieces(_canvas, img2);
				
				_ctx.save();
				
				//分享
				uploadFinalImg(document.getElementsByClassName("canvas-target")[0]);
			}
		};
		
		var rest = changePhotpBgIdx - Math.floor(changePhotpBgIdx / 3) * 3;
		
			switch(rest){
				case 0:
					//alert("1.1");
					document.getElementsByClassName("img-randbg")[0].src = "images/i5/bg-top1.jpg";
					document.getElementsByClassName("div-main-top")[0].style.backgroundImage = "url('images/i5/bg-top1.jpg')";
					document.getElementsByClassName("img-newframe")[0].src = "images/i5/img-frame1.png";
					//alert("1.9");
					break;
					
				case 1:
					//alert("2.1");
					document.getElementsByClassName("img-randbg")[0].src = "images/i5/bg-top2.jpg";
					document.getElementsByClassName("div-main-top")[0].style.backgroundImage = "url('images/i5/bg-top2.jpg')";
					document.getElementsByClassName("img-newframe")[0].src = "images/i5/img-frame2.png";
					//alert("2.9");
					break;
					
				case 2:
					//alert("3.1");
					document.getElementsByClassName("img-randbg")[0].src = "images/i5/bg-top3.jpg";
					document.getElementsByClassName("div-main-top")[0].style.backgroundImage = "url('images/i5/bg-top3.jpg')";
					img_newframe = document.getElementsByClassName("img-newframe")[0].src = "images/i5/img-frame3.png";
					
					//alert("3.9");
					break;
					
				default:
					break;
			}
		
	}
	
	function setImageFrame(){
		var rest = changePhotpBgIdx - Math.floor(changePhotpBgIdx / 3) * 3;
	}
	
	function uploadFinalImg(canvas){
		
		//var _url = 'http://test.zhangkuo.net/advmessage/advimage/saveImgJsonP.action?advid=30025';
		var _url = 'http://ama.adwo.com/advmessage/advimage/saveImgJsonP.action?advid=30025';
		$.ajax({
			type:'POST',
			url:_url,
			cache: false,
			timeout:60000,
			dataType : 'jsonp',
			data:{
				imagebase64:canvas.toDataURL("image/jpeg"),
				remark:2
			},
			jsonpCallback: "eventcallback3",
			success:function(d){
				//$('div#load2').hide();
				if(1 === d.success){
					//var title = document.getElementsByClassName("hidden-text")[0].value;
					var title = "新浪微博#青春逗比邂逅金石滩#@大连金石滩景区";
					var imgUrl = d.imageurl;
					var imgId = d.imageid;
					
					var content = encodeURIComponent(title);
					var _curUrl = encodeURIComponent(window.location.href);
					window.location.href = "http://service.weibo.com/share/share.php?url=" + _curUrl + "&appkey=&title=" + content + "&pic=" + imgUrl + "&ralateUid=&language=";
					//window.open(imgUrl);
					alert("分享新浪微博，跳转进行中，请稍候...");
				}
				else{
					alert('非常抱歉，上传失败。');
				}
				isSubmit = false;
				isInsubmit = false;
			},
			error:function(d){
				//$('div#load2').hide();
				alert('抱歉，由于网络原因上传失败，请检查网络');
			
			}
		});
	}
	
	window.addEventListener('shake', function(){
		isSubmit = false;
		changePhotpBgIdx++;
		updatePhoto();//更新背景图，但是不上传图片
	}, false);
	
</script>
</html>