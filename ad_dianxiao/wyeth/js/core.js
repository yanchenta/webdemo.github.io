var prov = [{"provinceid":1,"provincename":"安徽","cities":[{"cityid":31,"cityname":"安庆市"},{"cityid":32,"cityname":"蚌埠市"},{"cityid":33,"cityname":"合肥市"},{"cityid":34,"cityname":"淮北市"},{"cityid":35,"cityname":"淮南市"},{"cityid":36,"cityname":"马鞍山市"},{"cityid":37,"cityname":"宿州市"},{"cityid":38,"cityname":"铜陵市"},{"cityid":39,"cityname":"芜湖市"},{"cityid":40,"cityname":"宣城市"}]},{"provinceid":2,"provincename":"北京","cities":[{"cityid":41,"cityname":"北京市"}]},{"provinceid":3,"provincename":"东北","cities":[{"cityid":43,"cityname":"大庆"},{"cityid":44,"cityname":"哈尔滨"}]},{"provinceid":4,"provincename":"福建","cities":[{"cityid":45,"cityname":"安溪县"},{"cityid":46,"cityname":"长乐市"},{"cityid":47,"cityname":"德化县"},{"cityid":48,"cityname":"福安市"},{"cityid":49,"cityname":"福清市"},{"cityid":50,"cityname":"福州市"},{"cityid":51,"cityname":"惠安县"},{"cityid":52,"cityname":"建瓯市"},{"cityid":53,"cityname":"晋江市"},{"cityid":54,"cityname":"连江县"},{"cityid":55,"cityname":"龙海市"},{"cityid":56,"cityname":"龙岩市"},{"cityid":57,"cityname":"闽侯县"},{"cityid":58,"cityname":"南安市"},{"cityid":59,"cityname":"南平市"},{"cityid":60,"cityname":"宁德市"},{"cityid":61,"cityname":"莆田市"},{"cityid":62,"cityname":"泉州市"},{"cityid":63,"cityname":"三明市"},{"cityid":64,"cityname":"石狮市"},{"cityid":65,"cityname":"厦门市"},{"cityid":66,"cityname":"永安市"},{"cityid":67,"cityname":"永春县"},{"cityid":68,"cityname":"漳浦县"},{"cityid":69,"cityname":"漳州市"}]},{"provinceid":5,"provincename":"甘肃","cities":[{"cityid":70,"cityname":"酒泉市"},{"cityid":71,"cityname":"兰州市"},{"cityid":72,"cityname":"银川市"}]},{"provinceid":6,"provincename":"广东","cities":[{"cityid":73,"cityname":"博罗县"},{"cityid":74,"cityname":"潮州市"},{"cityid":75,"cityname":"从化市"},{"cityid":76,"cityname":"东莞市"},{"cityid":77,"cityname":"佛山市"},{"cityid":78,"cityname":"广州市"},{"cityid":79,"cityname":"海丰县"},{"cityid":80,"cityname":"河源市"},{"cityid":81,"cityname":"惠东县"},{"cityid":82,"cityname":"惠州市"},{"cityid":83,"cityname":"江门市"},{"cityid":84,"cityname":"揭阳市"},{"cityid":85,"cityname":"开平市"},{"cityid":86,"cityname":"连州市"},{"cityid":87,"cityname":"陆丰市"},{"cityid":88,"cityname":"茂名市"},{"cityid":89,"cityname":"梅州市"},{"cityid":90,"cityname":"普宁市"},{"cityid":91,"cityname":"清远市"},{"cityid":92,"cityname":"汕头市"},{"cityid":93,"cityname":"汕尾市"},{"cityid":94,"cityname":"韶关市"},{"cityid":95,"cityname":"深圳市"},{"cityid":96,"cityname":"台山市"},{"cityid":97,"cityname":"兴宁市"},{"cityid":98,"cityname":"阳春市"},{"cityid":99,"cityname":"阳江市"},{"cityid":100,"cityname":"英德市"},{"cityid":101,"cityname":"云浮市"},{"cityid":102,"cityname":"增城市"},{"cityid":103,"cityname":"湛江市"},{"cityid":104,"cityname":"肇庆市"},{"cityid":105,"cityname":"中山市"},{"cityid":106,"cityname":"珠海市"}]},{"provinceid":7,"provincename":"广西","cities":[{"cityid":107,"cityname":"百色市"},{"cityid":108,"cityname":"苍梧县"},{"cityid":109,"cityname":"岑溪市"},{"cityid":110,"cityname":"贵港市"},{"cityid":111,"cityname":"桂林市"},{"cityid":112,"cityname":"河池市"},{"cityid":113,"cityname":"柳州市"},{"cityid":114,"cityname":"南宁市"},{"cityid":115,"cityname":"钦州市"},{"cityid":116,"cityname":"梧州市"},{"cityid":117,"cityname":"武鸣县"},{"cityid":118,"cityname":"玉林市"}]},{"provinceid":8,"provincename":"贵州","cities":[{"cityid":119,"cityname":"安顺市"},{"cityid":120,"cityname":"毕节市"},{"cityid":121,"cityname":"都匀市"},{"cityid":122,"cityname":"贵阳市"},{"cityid":123,"cityname":"六盘水市"},{"cityid":124,"cityname":"遵义市"}]},{"provinceid":9,"provincename":"海南","cities":[{"cityid":125,"cityname":"海口市"},{"cityid":126,"cityname":"三亚市"}]},{"provinceid":10,"provincename":"河北","cities":[{"cityid":127,"cityname":"保定市"},{"cityid":42,"cityname":"三河市"},{"cityid":129,"cityname":"承德市"},{"cityid":130,"cityname":"邯郸市"},{"cityid":131,"cityname":"廊坊市"},{"cityid":132,"cityname":"三河市"},{"cityid":133,"cityname":"石家庄市"},{"cityid":134,"cityname":"唐山市"},{"cityid":135,"cityname":"张家口市"}]},{"provinceid":11,"provincename":"河南","cities":[{"cityid":136,"cityname":"安阳市"},{"cityid":137,"cityname":"登封市"},{"cityid":138,"cityname":"巩义市"},{"cityid":139,"cityname":"济源市"},{"cityid":140,"cityname":"开封市"},{"cityid":141,"cityname":"洛阳市"},{"cityid":142,"cityname":"南阳市"},{"cityid":143,"cityname":"平顶山市"},{"cityid":144,"cityname":"三门峡市"},{"cityid":145,"cityname":"商丘市"},{"cityid":146,"cityname":"新密市"},{"cityid":147,"cityname":"新乡市"},{"cityid":148,"cityname":"新郑市"},{"cityid":149,"cityname":"信阳市"},{"cityid":150,"cityname":"许昌市"},{"cityid":151,"cityname":"郑州市"},{"cityid":152,"cityname":"周口市"},{"cityid":153,"cityname":"驻马店市"}]},{"provinceid":12,"provincename":"黑龙江","cities":[{"cityid":154,"cityname":"大庆市"},{"cityid":155,"cityname":"哈尔滨市"},{"cityid":156,"cityname":"鸡西市"},{"cityid":157,"cityname":"佳木斯市"},{"cityid":158,"cityname":"齐齐哈尔市"}]},{"provinceid":13,"provincename":"湖北","cities":[{"cityid":159,"cityname":"大冶"},{"cityid":160,"cityname":"鄂州市"},{"cityid":161,"cityname":"恩施市"},{"cityid":162,"cityname":"黄冈市"},{"cityid":163,"cityname":"黄石市"},{"cityid":164,"cityname":"荆门市"},{"cityid":165,"cityname":"荆州市"},{"cityid":166,"cityname":"利川市"},{"cityid":167,"cityname":"潜江市"},{"cityid":168,"cityname":"十堰市"},{"cityid":169,"cityname":"随州市"},{"cityid":170,"cityname":"天门市"},{"cityid":171,"cityname":"武汉"},{"cityid":172,"cityname":"武汉市"},{"cityid":173,"cityname":"浠水县"},{"cityid":174,"cityname":"仙桃市"},{"cityid":175,"cityname":"咸宁市"},{"cityid":176,"cityname":"襄樊.市区"},{"cityid":177,"cityname":"襄樊市"},{"cityid":178,"cityname":"孝感市"},{"cityid":179,"cityname":"宜昌市"},{"cityid":180,"cityname":"应城市"},{"cityid":181,"cityname":"枣阳市"}]},{"provinceid":14,"provincename":"湖南","cities":[{"cityid":182,"cityname":"长沙市"},{"cityid":183,"cityname":"常德市"},{"cityid":184,"cityname":"常宁市"},{"cityid":185,"cityname":"郴州市"},{"cityid":186,"cityname":"桂阳县"},{"cityid":187,"cityname":"汉寿县"},{"cityid":188,"cityname":"衡阳市"},{"cityid":189,"cityname":"怀化市"},{"cityid":190,"cityname":"耒阳市"},{"cityid":191,"cityname":"澧县"},{"cityid":192,"cityname":"临湘市"},{"cityid":193,"cityname":"浏阳市"},{"cityid":194,"cityname":"汨罗市"},{"cityid":195,"cityname":"湘潭市"},{"cityid":196,"cityname":"益阳市"},{"cityid":197,"cityname":"永州市"},{"cityid":198,"cityname":"岳阳市"},{"cityid":199,"cityname":"张家界市"},{"cityid":200,"cityname":"株洲市"}]},{"provinceid":15,"provincename":"吉林","cities":[{"cityid":201,"cityname":"长春市"}]},{"provinceid":16,"provincename":"江苏","cities":[{"cityid":202,"cityname":"常熟市"},{"cityid":203,"cityname":"常州市"},{"cityid":204,"cityname":"滁州市"},{"cityid":205,"cityname":"丹阳市"},{"cityid":206,"cityname":"高邮市"},{"cityid":207,"cityname":"海安县"},{"cityid":208,"cityname":"海门市"},{"cityid":209,"cityname":"毫州市"},{"cityid":210,"cityname":"淮安市"},{"cityid":211,"cityname":"江都市"},{"cityid":212,"cityname":"江阴市"},{"cityid":213,"cityname":"金坛市"},{"cityid":214,"cityname":"句容市"},{"cityid":215,"cityname":"昆山市"},{"cityid":216,"cityname":"溧阳市"},{"cityid":217,"cityname":"连云港市"},{"cityid":218,"cityname":"南京市"},{"cityid":219,"cityname":"南通市"},{"cityid":220,"cityname":"启东市"},{"cityid":221,"cityname":"如东县"},{"cityid":222,"cityname":"如皋市"},{"cityid":223,"cityname":"苏州市"},{"cityid":224,"cityname":"宿迁市"},{"cityid":225,"cityname":"太仓市"},{"cityid":226,"cityname":"泰兴市"},{"cityid":227,"cityname":"泰州市"},{"cityid":228,"cityname":"通州市"},{"cityid":229,"cityname":"无锡市"},{"cityid":230,"cityname":"吴江市"},{"cityid":231,"cityname":"兴化市"},{"cityid":232,"cityname":"徐州市"},{"cityid":233,"cityname":"盐城市"},{"cityid":234,"cityname":"扬中市"},{"cityid":235,"cityname":"扬州市"},{"cityid":236,"cityname":"仪征市"},{"cityid":237,"cityname":"宜兴市"},{"cityid":238,"cityname":"张家港市"},{"cityid":239,"cityname":"镇江市"}]},{"provinceid":17,"provincename":"江西","cities":[{"cityid":240,"cityname":"抚州市"},{"cityid":241,"cityname":"赣州市"},{"cityid":242,"cityname":"吉安市"},{"cityid":243,"cityname":"九江市"},{"cityid":244,"cityname":"南昌市"},{"cityid":245,"cityname":"瑞金市"},{"cityid":246,"cityname":"新余市"},{"cityid":247,"cityname":"宜春市"}]},{"provinceid":18,"provincename":"辽宁","cities":[{"cityid":248,"cityname":"鞍山市"},{"cityid":249,"cityname":"本溪市"},{"cityid":250,"cityname":"大连市"},{"cityid":251,"cityname":"丹东市"},{"cityid":252,"cityname":"抚顺市"},{"cityid":253,"cityname":"葫芦岛市"},{"cityid":254,"cityname":"锦州市"},{"cityid":255,"cityname":"盘锦市"},{"cityid":256,"cityname":"沈阳市"}]},{"provinceid":19,"provincename":"闽赣","cities":[{"cityid":257,"cityname":"南昌市"}]},{"provinceid":20,"provincename":"内蒙古","cities":[{"cityid":258,"cityname":"包头市"},{"cityid":259,"cityname":"呼和浩特市"}]},{"provinceid":21,"provincename":"山东","cities":[{"cityid":260,"cityname":"滨州市"},{"cityid":261,"cityname":"昌邑市"},{"cityid":262,"cityname":"德州市"},{"cityid":263,"cityname":"东营市"},{"cityid":264,"cityname":"菏泽市"},{"cityid":265,"cityname":"即墨市"},{"cityid":266,"cityname":"济南市"},{"cityid":267,"cityname":"济宁市"},{"cityid":268,"cityname":"胶南市"},{"cityid":269,"cityname":"胶州市"},{"cityid":270,"cityname":"莒县"},{"cityid":271,"cityname":"莱芜市"},{"cityid":272,"cityname":"莱西市"},{"cityid":273,"cityname":"莱阳市"},{"cityid":274,"cityname":"莱州市"},{"cityid":275,"cityname":"聊城市"},{"cityid":276,"cityname":"临沭县"},{"cityid":277,"cityname":"临沂市"},{"cityid":278,"cityname":"龙口市"},{"cityid":279,"cityname":"平度市"},{"cityid":280,"cityname":"平邑县"},{"cityid":281,"cityname":"青岛市"},{"cityid":282,"cityname":"日照市"},{"cityid":283,"cityname":"荣成市"},{"cityid":284,"cityname":"乳山市"},{"cityid":285,"cityname":"寿光市"},{"cityid":286,"cityname":"泰安市"},{"cityid":287,"cityname":"威海市"},{"cityid":288,"cityname":"潍坊市"},{"cityid":289,"cityname":"文登市"},{"cityid":290,"cityname":"烟台市"},{"cityid":291,"cityname":"章丘市"},{"cityid":292,"cityname":"淄博市"}]},{"provinceid":22,"provincename":"山西","cities":[{"cityid":293,"cityname":"大同市"},{"cityid":294,"cityname":"临汾市"},{"cityid":295,"cityname":"太原市"},{"cityid":296,"cityname":"运城市"}]},{"provinceid":23,"provincename":"陕西","cities":[{"cityid":297,"cityname":"安康市"},{"cityid":298,"cityname":"宝鸡市"},{"cityid":299,"cityname":"汉中市"},{"cityid":300,"cityname":"渭南市"},{"cityid":301,"cityname":"西安市"},{"cityid":302,"cityname":"咸阳市"},{"cityid":303,"cityname":"榆林市"}]},{"provinceid":24,"provincename":"上海","cities":[{"cityid":304,"cityname":"上海市"}]},{"provinceid":25,"provincename":"四川","cities":[{"cityid":305,"cityname":"成都市"},{"cityid":306,"cityname":"崇州市"},{"cityid":307,"cityname":"大邑县"},{"cityid":308,"cityname":"德阳市"},{"cityid":309,"cityname":"广安市"},{"cityid":310,"cityname":"广汉市"},{"cityid":311,"cityname":"简阳市"},{"cityid":312,"cityname":"江油市"},{"cityid":313,"cityname":"乐山市"},{"cityid":314,"cityname":"泸州市"},{"cityid":315,"cityname":"眉山市"},{"cityid":316,"cityname":"绵阳市"},{"cityid":317,"cityname":"内江市"},{"cityid":318,"cityname":"南充市"},{"cityid":319,"cityname":"攀枝花市"},{"cityid":320,"cityname":"彭州市"},{"cityid":321,"cityname":"郫县"},{"cityid":322,"cityname":"射洪县"},{"cityid":323,"cityname":"双流县"},{"cityid":324,"cityname":"遂宁市"},{"cityid":325,"cityname":"宜宾市"},{"cityid":326,"cityname":"资阳市"},{"cityid":327,"cityname":"自贡市"}]},{"provinceid":26,"provincename":"天津","cities":[{"cityid":328,"cityname":"天津市"}]},{"provinceid":27,"provincename":"新疆","cities":[{"cityid":329,"cityname":"乌鲁木齐市"}]},{"provinceid":28,"provincename":"云南","cities":[{"cityid":330,"cityname":"安宁市"},{"cityid":331,"cityname":"楚雄市"},{"cityid":332,"cityname":"大理市"},{"cityid":333,"cityname":"个旧市"},{"cityid":334,"cityname":"景洪市"},{"cityid":335,"cityname":"开远市"},{"cityid":336,"cityname":"昆明市"},{"cityid":337,"cityname":"曲靖市"},{"cityid":338,"cityname":"瑞丽市"},{"cityid":339,"cityname":"思茅市"},{"cityid":340,"cityname":"文山县"},{"cityid":341,"cityname":"玉溪市"},{"cityid":342,"cityname":"昭通市"}]},{"provinceid":29,"provincename":"浙江","cities":[{"cityid":343,"cityname":"苍南县"},{"cityid":344,"cityname":"长兴县"},{"cityid":345,"cityname":"慈溪市"},{"cityid":346,"cityname":"德清县"},{"cityid":347,"cityname":"东阳市"},{"cityid":348,"cityname":"奉化市"},{"cityid":349,"cityname":"富阳市"},{"cityid":350,"cityname":"海宁市"},{"cityid":351,"cityname":"杭州市"},{"cityid":352,"cityname":"湖州市"},{"cityid":353,"cityname":"嘉善县"},{"cityid":354,"cityname":"嘉兴市"},{"cityid":355,"cityname":"建德市"},{"cityid":356,"cityname":"江山市"},{"cityid":357,"cityname":"金华市"},{"cityid":358,"cityname":"乐清市"},{"cityid":359,"cityname":"丽水市"},{"cityid":360,"cityname":"临安市"},{"cityid":361,"cityname":"临海市"},{"cityid":362,"cityname":"宁波市"},{"cityid":363,"cityname":"宁海县"},{"cityid":364,"cityname":"平阳县"},{"cityid":365,"cityname":"青田县"},{"cityid":366,"cityname":"衢州市"},{"cityid":367,"cityname":"瑞安市"},{"cityid":368,"cityname":"上虞市"},{"cityid":369,"cityname":"绍兴市"},{"cityid":370,"cityname":"绍兴县"},{"cityid":371,"cityname":"嵊州市"},{"cityid":372,"cityname":"台州市"},{"cityid":373,"cityname":"天台县"},{"cityid":374,"cityname":"桐庐县"},{"cityid":375,"cityname":"桐乡市"},{"cityid":376,"cityname":"温岭市"},{"cityid":377,"cityname":"温州市"},{"cityid":378,"cityname":"仙居县"},{"cityid":379,"cityname":"象山县"},{"cityid":380,"cityname":"新昌县"},{"cityid":381,"cityname":"义乌市"},{"cityid":382,"cityname":"永嘉县"},{"cityid":383,"cityname":"永康市"},{"cityid":384,"cityname":"余姚市"},{"cityid":385,"cityname":"玉环县"},{"cityid":386,"cityname":"舟山市"},{"cityid":387,"cityname":"诸暨市"}]},{"provinceid":30,"provincename":"重庆","cities":[{"cityid":388,"cityname":"重庆市"}]}]

;

function setProvenices(pId, cId) {
   
        var htmlContent = '';
        
        for (var i = 0; i < prov.length; i++) {
			if(pId!=undefined){
				var isCurr = false;
				for(var j = 0;j<prov[i].cities.length;j++){
					if(pId.indexOf(prov[i].cities[j].cityname) !=-1){
						isCurr = true;
					}else{
						//isCurr = false;
					}
				}
				if(isCurr){
					htmlContent += '<option value="' + prov[i].provinceid + '" data-value='+prov[i].provincename+' selected="selected">' + prov[i].provincename + '</option>';
					setCities(prov[i].provinceid,pId);
				}else{
					htmlContent += '<option value="' + prov[i].provinceid + '" data-value='+prov[i].provincename+'>' + prov[i].provincename + '</option>'
				}
				
			}else{
				htmlContent += '<option value="' + prov[i].provinceid + '" data-value='+prov[i].provincename+'>' + prov[i].provincename + '</option>'
			}		
			

        }
        if (htmlContent == '') return;
        htmlContent = '<option value="0">省份</option>' + htmlContent;
        $(".prov").html(htmlContent);

       
    

}

function setCities(pId, cId) {
   
    for (var i = 0; i < prov.length; i++) {

        if (pId != prov[i].provinceid) continue;
        var cities = prov[i].cities;
        var htmlContent = '';
        for (var j = 0; j < cities.length; j++) {
			if(cId){
				if(cId.indexOf(cities[j].cityname) !=-1){
				htmlContent += '<option value="' + cities[j].cityid + '" data-value='+cities[j].cityname+' selected="selected">' + cities[j].cityname + '</option>';
                    GetDealers(cities[j].cityid);
				}else{
					htmlContent += '<option value="' + cities[j].cityid + '" data-value='+cities[j].cityname+'>' + cities[j].cityname + '</option>'
				}
			}else{
				htmlContent += '<option value="' + cities[j].cityid + '" data-value='+cities[j].cityname+'>' + cities[j].cityname + '</option>'
			}
			
            
        }
        if (htmlContent == '') return;
        htmlContent = '<option value="0">城市</option>' + htmlContent;
        $(".city").html(htmlContent);

        
    }
}

var map, position,currentCity;
var i = 0, j = 0,cityId;


function getCorrdsError() {
	//alert("无法获取您的当前位置，您可以尝试在设置里打开浏览器的定位服务，并刷新页面。");
	var myCity = new BMap.LocalCity();
	myCity.get(getCityCenter);
	
}
function getCityCenter(result) {
	if (result.name != "") {
		currentCity = result.name;
		//alert(currentCity);
		//setProvenices(currentCity);
		setProvenices(currentCity);
		position = result.center;
		translateCallback(position);
		//BMap.Convertor.translate(position, 0, translateCallback);
	}
}
function translateCallback(pos) {
	position = pos;
	CreateMap();

}
function showDealers(cityId){
   // var s=new Dealer({point:position,map:map});
	GetDealers(cityId);
}
function GetDealers(cityId){
	var url='http://track.mobile1.com.cn/advmessage/dealer/getDealerByAreaIdJsonP.action?advid=10023';
	$.ajax({
		url: url,
		cache: false,
		dataType : 'jsonp',
		jsonpCallback: "eventcallbackInfo",
		data: {cityid: cityId},
		success: setDealers
	});
}
function setDealers(j){
	for(var i =0;i< j[0].length;i++){
		j[0][i].map=map;
		var adwoD= new Dealer(j[0][i]);
	}
}
function getCoords(pos) {
	if ( typeof (pos.point) !== "undefined") {
		position = pos.point;
	} else {
		position = new BMap.Point(pos.coords.longitude, pos.coords.latitude);
		BMap.Convertor.translate(position, 0, translateCallback);
	}
}
function CreateMap() {
	map = new BMap.Map("canvas");
	var myCity = new BMap.LocalCity();
	myCity.get(getCity);
	var geolocation = new BMap.Geolocation();
	//alert(geolocation);
	geolocation.getCurrentPosition(currentIcon);
	map.centerAndZoom(position, 12);
	map.disableDoubleClickZoom();
}

function currentIcon(r){
	//http://wireless.audi.cn/common/images/curr-icon.png
	var myIcon = new BMap.Icon("http://wyeth.mobile1.com.cn/images/dress.png", new BMap.Size(18, 32));	
	var mk = new BMap.Marker(position, { icon: myIcon });
	map.addOverlay(mk);
	mk.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的动画
	map.panTo(position);
}

function getCity(r){
	setProvenices(r.name);
}

window.onload = function(){
	var pageHeight = parseInt(document.body.scrollHeight) - 246;
	//alert(document.body.scrollHeight);
	//alert(pageHeight);
	$('#canvas').height(pageHeight);
	resetPage();
	setProvenices();
    $(".prov").live("change", function () {
		var provinceid = $(this).val();
		setCities(provinceid);
    });
	if (window.navigator) {
		navigator.geolocation.getCurrentPosition(getCoords, getCorrdsError, {
			enableHighAcuracy : true,
			timeout : 5000,
			maximumAge : 3000
		});
	} else {
		getCorrdsError();
	}
	
	$('#cities').live('change',function(){
		cityId=$(this).val();
		var cityName=$(this).find("option:selected").text();
		map.setCenter(cityName);
		GetDealers(cityId);
	});
}

window.onresize = function(){
	resetPage();
	
	
}

function resetPage() {
	var deviceWidth = document.documentElement.clientWidth,
	scale = deviceWidth/320;
	document.body.style.zoom = scale;
}